#Find the source and header files.  This isn't great practice because you have to
#rerun cmake to detect new files to link.
file(GLOB SOURCE_FILES *.cxx)
file(GLOB HEADER_FILES *.h)

#Include build system for the rest of this project.  Add new top-level directories here.
#First, build a ROOT dictionary
#I modified this dictionary generation code from Heidi's CMakeLists.txt
REFLEX_GENERATE_DICTIONARY(${PROJECT_NAME} ${CMAKE_CURRENT_SOURCE_DIR}/../dict/PlotUtilsDict.h SELECTION ${CMAKE_CURRENT_SOURCE_DIR}/../dict/PlotUtilsDict.xml OPTIONS -D__GCC_XML__ --noIncludePaths)

#MESSAGE("boost:$ENV{BOOSTDIR}")
#include_directories(PlotUtils $ENV{PLOTUTILSROOT} $ENV{BOOSTDIR}/include $ENV{BOOSTDIR})

#install the dictionary files ROOT generates where LD_LIBRARY_PATH can find them
#(after sourcing setup.sh of course)
#Taken from Clark McGrew's edepsim package
if(${ROOT_VERSION} VERSION_GREATER 6)
  install(FILES ${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}Dict.rootmap
    DESTINATION lib)
  install(FILES ${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}_rdict.pcm
    DESTINATION lib)

  #In the transition to ROOT 6, dictionary files generated by reflex
  #through ROOT adopted a different naming convention.  The commit
  #that changed this was https://github.com/root-project/root/commit/d62b4fed98805d45079f9863
  set(DICTIONARY_NAME ${PROJECT_NAME}.cxx)
else(${ROOT_VERSION} VERSION_GREATER 6)
  set(DICTIONARY_NAME ${PROJECT_NAME}_dict.cpp)
endif(${ROOT_VERSION} VERSION_GREATER 6)

#Build a library from the dictionary source code ROOT generated.  I'll need it both to load
#this project into the interpreter and to put some more information into libMAT.so.
#add_library(${PROJECT_NAME}Dict SHARED ${CMAKE_CURRENT_BINARY_DIR}/${DICTIONARY_NAME})
#target_link_libraries(${PROJECT_NAME}Dict ${ROOT_LIBRARIES})
#install(TARGETS ${PROJECT_NAME}Dict EXPORT ${PROJECT_NAME}Targets DESTINATION lib)

#Now, build libMAT
add_library(${PROJECT_NAME} SHARED ${SOURCE_FILES} ${CMAKE_CURRENT_BINARY_DIR}/${DICTIONARY_NAME})
target_link_libraries(${PROJECT_NAME} ${ROOT_LIBRARIES})
install(TARGETS ${PROJECT_NAME} EXPORT ${PROJECT_NAME}Targets DESTINATION lib)
install(CODE "EXECUTE_PROCESS( COMMAND ${CMAKE_COMMAND} -E create_symlink ${CMAKE_INSTALL_PREFIX}/lib/lib${PROJECT_NAME}.so ${CMAKE_INSTALL_PREFIX}/lib/lib${PROJECT_NAME}Dict.so )" ) #Make a symbolic link to the "magic" file name that older ROOT 6 versions look for.
install(FILES ${HEADER_FILES} ${SOURCE_FILES} DESTINATION include/PlotUtils)
install(EXPORT ${PROJECT_NAME}Targets DESTINATION lib/cmake/${PROJECT_NAME})

export(TARGETS ${PROJECT_NAME} FILE ${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}Targets.cmake)
